<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–ª–∞–Ω v8.0 (–ü—Ä–æ–ø—É—Å–∫ —ç—Ç–∞–ø–æ–≤)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; color: #333; padding-bottom: 100px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #2c3e50; }
        
        .form-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 20px; background: #fff; padding: 20px; border-radius: 10px; border: 1px solid #e0e0e0; }
        input { padding: 12px; border: 1px solid #dcdcdc; border-radius: 6px; outline: none; }
        
        .btn { cursor: pointer; padding: 12px 18px; border-radius: 6px; border: none; font-weight: 600; transition: 0.2s; }
        .btn-add { background: #27ae60; color: white; }
        .btn-delete { background: #e74c3c; color: white; padding: 5px 10px; font-size: 12px; }
        .btn-skip { background: #ff9800; color: white; padding: 5px 10px; font-size: 12px; }
        .btn-activate { background: #4CAF50; color: white; padding: 5px 10px; font-size: 12px; }
        .btn-backup { background: #3498db; color: white; }
        .btn-import { background: #8e44ad; color: white; }

        .shipment-block { border: 1px solid #3498db; margin-top: 30px; border-radius: 10px; overflow: hidden; background: #fff; }
        .shipment-header { background: #3498db; color: white; padding: 12px 20px; margin: 0; font-size: 1.2em; }
        
        .device-block { margin: 20px; padding: 20px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .day-plan-input { background: #fff9c4; border: 2px solid #fbc02d; font-weight: bold; width: 70px; text-align: center; }
        
        table { width: 100%; border-collapse: collapse; margin: 10px 0; background: white; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #95a5a6; font-size: 0.85em; }

        .stage-skipped td { text-decoration: line-through; color: #9e9e9e; }

        .summary-badges { display: flex; gap: 15px; margin-bottom: 15px; }
        .badge-style { padding: 10px 15px; border-radius: 6px; font-weight: bold; }
        .badge-unit { background: #01579b; color: white; }
        .badge-plan { background: #ff6f00; color: white; }

        .summary-footer { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #2c3e50; color: white; padding: 20px; 
            text-align: center; font-size: 1.3em; box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
            z-index: 1000; display: flex; justify-content: center; gap: 40px;
        }
        .summary-val { color: #f1c40f; font-weight: bold; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üè≠ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞</h1>

    <div class="form-group">
        <input type="text" id="shipmentName" placeholder="üì¶ –ü–æ—Å—Ç–∞–≤–∫–∞">
        <input type="text" id="deviceName" placeholder="üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ">
        <input type="text" id="stageName" placeholder="üõ† –ù–∞–∑–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–∞">
        <input type="number" id="stageTime" placeholder="‚è± –ú–∏–Ω">
        <input type="number" id="totalCount" placeholder="üéØ –û–±—â–∏–π –ø–ª–∞–Ω">
        <button class="btn btn-add" onclick="addData()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:20px; justify-content: center;">
        <button class="btn btn-backup" onclick="exportJSON()">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="btn btn-import" onclick="document.getElementById('fileInput').click()">üìÇ –ò–º–ø–æ—Ä—Ç</button>
        <input type="file" id="fileInput" accept=".json" onchange="importJSON(event)">
        <button class="btn" style="background:#95a5a6; color:white" onclick="clearData()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div id="dataOutput"></div>
</div>

<div class="summary-footer" id="finalSummary">
</div>

<script>
    let db = JSON.parse(localStorage.getItem('assemblyData')) || {};

    function addData() {
        const s = document.getElementById('shipmentName').value.trim();
        const d = document.getElementById('deviceName').value.trim();
        const stage = document.getElementById('stageName').value.trim();
        const time = parseInt(document.getElementById('stageTime').value);
        const total = parseInt(document.getElementById('totalCount').value) || 0;

        if (!s || !d || !stage || isNaN(time)) { alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!"); return; }

        if (!db[s]) db[s] = {};
        if (!db[s][d]) db[s][d] = { stages: [], totalCount: total, dayPlan: 0 };

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ isEnabled –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true
        db[s][d].stages.push({ id: Date.now(), name: stage, time: time, isEnabled: true });
        if (total > 0) db[s][d].totalCount = total;
        
        saveAndRender();
        document.getElementById('stageName').value = '';
        document.getElementById('stageTime').value = '';
    }

    function toggleStageEnable(s, d, stageId) {
        // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–π —ç—Ç–∞–ø –∏ –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –µ–≥–æ —Å—Ç–∞—Ç—É—Å isEnabled
        const stage = db[s][d].stages.find(st => st.id === stageId);
        if (stage) {
            stage.isEnabled = !stage.isEnabled;
            saveAndRender();
        }
    }

    function updateDayPlan(s, d, val) {
        db[s][d].dayPlan = parseInt(val) || 0;
        saveAndRender();
    }

    function deleteStage(shipKey, devKey, stageId) {
        db[shipKey][devKey].stages = db[shipKey][devKey].stages.filter(st => st.id !== stageId);
        if (db[shipKey][devKey].stages.length === 0) delete db[shipKey][devKey];
        if (Object.keys(db[shipKey]).length === 0) delete db[shipKey];
        saveAndRender();
    }

    function exportJSON() {
        const blob = new Blob([JSON.stringify(db, null, 2)], {type : 'application/json'});
        const url = URL.createObjectURL(blob);
        const dl = document.createElement('a');
        dl.href = url;
        dl.download = `factory_backup.json`;
        dl.click();
    }

    function importJSON(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { db = JSON.parse(ev.target.result); saveAndRender(); };
        reader.readAsText(e.target.files);
    }

    function clearData() { if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏?")) { db = {}; saveAndRender(); } }

    function saveAndRender() {
        localStorage.setItem('assemblyData', JSON.stringify(db));
        render();
    }

    function render() {
        const out = document.getElementById('dataOutput');
        const summaryDiv = document.getElementById('finalSummary');
        out.innerHTML = '';
        let totalMinutesToday = 0;
        let totalItemsToday = 0;

        for (const s in db) {
            let sHtml = `<div class="shipment-block"><h2 class="shipment-header">üì¶ –ü–æ—Å—Ç–∞–≤–∫–∞: ${s}</h2>`;
            for (const d in db[s]) {
                const dev = db[s][d];
                let timePerUnit = 0;
                let rows = '';
                
                dev.stages.forEach(st => {
                    // –°—á–∏—Ç–∞–µ–º –≤—Ä–µ–º—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–∞–ø –∞–∫—Ç–∏–≤–µ–Ω
                    if (st.isEnabled !== false) { 
                        timePerUnit += st.time;
                    }
                    const statusClass = st.isEnabled === false ? 'stage-skipped' : '';
                    const buttonHtml = st.isEnabled === false ? 
                        `<button class="btn-activate" onclick="toggleStageEnable('${s}', '${d}', ${st.id})">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>` :
                        `<button class="btn-skip" onclick="toggleStageEnable('${s}', '${d}', ${st.id})">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>`;

                    rows += `<tr class="${statusClass}"><td>${st.name}</td><td>${st.time} –º–∏–Ω</td>
                        <td style="display: flex; gap: 5px;">
                            ${buttonHtml}
                            <button class="btn-delete" onclick="deleteStage('${s}', '${d}', ${st.id})">‚úï</button>
                        </td></tr>`;
                });

                const timeForDay = timePerUnit * dev.dayPlan;
                const totalPlanHours = (timePerUnit * (dev.totalCount || 0) / 60).toFixed(1);
                totalMinutesToday += timeForDay;
                totalItemsToday += dev.dayPlan;

                sHtml += `<div class="device-block">
                    <h3>üì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${d}</h3>
                    <div class="summary-badges">
                        <div class="badge-style badge-unit">–ù–∞ 1 —à—Ç: ${timePerUnit} –º–∏–Ω</div>
                        <div class="badge-style badge-plan">–ù–∞ –≤–µ—Å—å –ø–ª–∞–Ω: ${totalPlanHours} —á</div>
                    </div>
                    <div class="info-grid">
                        <div class="info-card">–ü–ª–∞–Ω –ø–æ—Å—Ç–∞–≤–∫–∏: <b>${dev.totalCount || 0} —à—Ç.</b></div>
                        <div class="info-card">–ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: 
                            <input type="number" class="day-plan-input" value="${dev.dayPlan}" onchange="updateDayPlan('${s}', '${d}', this.value)"> —à—Ç.
                        </div>
                    </div>
                    <table><thead><tr><th>–≠—Ç–∞–ø</th><th>–í—Ä–µ–º—è</th><th>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th></tr></thead><tbody>${rows}</tbody></table>
                    <div style="color:#0288d1; font-weight:bold;">
                        ‚è± –°–µ–≥–æ–¥–Ω—è –Ω–∞ —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${timeForDay} –º–∏–Ω (~ ${(timeForDay/60).toFixed(2)} —á)
                    </div>
                </div>`;
            }
            out.innerHTML += sHtml + `</div>`;
        }

        summaryDiv.innerHTML = `
            <div>–í—Å–µ–≥–æ –∏–∑–¥–µ–ª–∏–π —Å–µ–≥–æ–¥–Ω—è: <span class="summary-val">${totalItemsToday} —à—Ç.</span></div>
            <div>–û–ë–©–ï–ï –í–†–ï–ú–Ø –†–ê–ë–û–¢–´: <span class="summary-val">${(totalMinutesToday/60).toFixed(2)} —á.</span></div>
        `;
    }
    render();
</script>
</body>
</html>
